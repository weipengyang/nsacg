<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>维修信息</title>
    <meta name="description" content="爱养车" />
    <link href="/tpl/static/lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <link href="/tpl/static/lib/ligerUI/skins/ligerui-icons.css" rel="stylesheet" type="text/css" />
    <link href="/tpl/static/lib/ligerUI/skins/Gray2014/css/all.css" rel="stylesheet" />

    <script src="/tpl/static/lib/jquery/jquery-1.9.0.min.js" type="text/javascript"></script>
    <script src="/tpl/static/lib/ligerUI/js/ligerui.all.js" type="text/javascript"></script>
    <script src="/tpl/static/lib/json2.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(function ()
        {
            var form = $("#form1").ligerForm({
                inputWidth: 160, labelWidth: 85, space: 20,
                validate: true,
                buttons: [                    { text: "更新", width: 60, click: submitForm }                ],                tab: {
                    items: [
                        {
                            title: '基本信息',
                            fields: [
                                { display: "流水号", name: "流水号", newline: true, type: "hidden", },
                                { display: "业务编号 ", name: "业务编号", newline: true, type: "text" },
                                { display: "制单日期 ", name: "制单日期", newline: false, type: "text" },
                                { display: "制单人 ", name: "制单人", newline: false, type: "text" },
                                {
                                    display: "服务顾问", name: "接车人", newline: true, type: "combobox",
                                    options: {
                                        valueField: '姓名',
                                        textField: '姓名',
                                        autocomplete: true,
                                        url: '/index.php?g=Query&m=Consume&a=getfwgw',
                                    }
                                },
                                { display: "维修类别 ", name: "维修类别", newline: false, type: "text" },
                                { display: "保修类别 ", name: "保修类别", newline: false, type: "text" },
                                { display: "车牌号码", name: "车牌号码", newline: true, type: "text" },
                               {
                                    display: "品牌", name: "品牌", newline: false, type: "combobox",
                                    options: {
                                        valueField: '品牌',
                                        textField: '品牌',
                                        autocomplete: true,
                                        url: '/index.php?g=Query&m=Consume&a=getpinpai',
                                    }
                                },
                                {
                                    display: "车系", name: "车型", newline: false, type: "combobox",
                                    options: {
                                        valueField: '车型',
                                        textField: '车型',
                                        autocomplete: true,
                                        url: '/index.php?g=Query&m=Consume&a=getchexing',
                                    },

                                },
                                { display: "车辆类型", name: "车辆类别", newline: true, type: "combobox",
                                    options: {
                                        valueField: '类别',
                                        textField: '类别',
                                        autocomplete: true,
                                        url: '/index.php?g=Query&m=Consume&a=getcllb',
                                    },
                                },
                                { display: "年份 ", name: "年份", newline: false, type: "text" },
                                { display: "排量", name: "排量", newline: false, type: "text" },
                                {
                                    display: "颜色", name: "颜色", newline: true, type: "combobox",
                                    options: {
                                        valueField: '颜色',
                                        textField: '颜色',
                                        autocomplete: true,
                                        url: '/index.php?g=Query&m=Consume&a=yanse',
                                    },
                                },
                                {
                                    display: "外观", name: "外观", newline: false, type: "combobox",
                                    options: {
                                        valueField: '外观',
                                        textField: '外观',
                                        autocomplete: true,
                                        url: '/index.php?g=Query&m=Consume&a=waiguan',
                                    },
                                },
                                { display: "座位数", name: "座位数", newline: false, type: "text" },
                                { display: "车架号", name: "车架号", newline: true, type: "text"},
                                { display: "轮胎规格", name: "轮胎规格",newline: false, type: "text" },
                                { display: "机油格", name: "机油格", newline: false, type: "text" },
                                { display: "空气格", name: "空气格", newline: true, type: "text" },
                                { display: "冷气格", name: "冷气格", newline: false, type: "text" },
                                { display: "汽油格", name: "汽油格", newline: false, type: "text" },
                                { display: "刹车皮", name: "刹车皮", newline: true, type: "text" },
                                { display: "发动机号", name: "发动机号", newline: false, type: "text" },
                                { display: "发动机型号", name: "发动机型号", newline: false, type: "text" },
                                { display: "电池", name: "电池", newline: true, type: "text" },
                               {
                                    display: "车主", name: "车主", newline: false, type: "popup", options: {
                                        condition: {
                                            prefixID: 'condtion_',
                                            fields: [{ name: 'searchkey', type: 'text', width: 120, label: '客户信息', labelWidth: 90 }]
                                            
                                        },
                                        onSelected: function (e) {
                                            alert(e.value);
                                            var row = e.data[0];
                                            $("input[name='联系电话']").val(row['联系电话']);
                                        },
                                        searchClick: function (e) {
                                            e.grid.set('parms', { 'searchkey': e.rules[0]['value'] });
                                            e.grid.reload();
                                        },
                                        grid: getGridOptions(false),
                                        valueField: '名称',
                                        textField: '名称',
                                        width: 600
                                    }
                                },
                                {
                                    display: "客户类别", name: "客户类别", newline: false, type: "combobox",
                                    options: {
                                        valueField: '类别',
                                        textField: '类别',
                                        autocomplete: true,
                                        url: '/index.php?g=Query&m=Consume&a=getkhlb',
                                    }

                                },
                                { display: "联系人", name: "联系人", newline: true, type: "text" },
                                { display: "联系电话", name: "联系电话", newline: false, type: "text" },
                                { display: "手机号", name: "手机号码", newline: false, type: "text" },
                                { display: "地址", name: "地址", newline: true, type: "text" },
                                { display: "身份证号", name: "身份证号", newline: false, type: "text" },
                                { display: "送修人", name: "送修人", newline: false, type: "text" },
                                { display: "送修人电话", name: "送修人电话", newline: true, type: "text" },
                                { display: "进厂时间", name: "进厂时间", newline: false, type: "text" },
                                { display: "预计完工", name: "预计完工", newline: false, type: "text" },
                                { display: "进厂里程", name: "进厂里程", newline: true, type: "text" },
                                { display: "油表数", name: "油表数", newline: false, type: "text" },
                                { display: "购买日期", name: "购买日期", newline: false, type: "text" },
                                { display: "车管单位", name: "车管单位", newline: true, type: "text" },
                                { display: "下次保养 ", name: "下次保养", newline: false, type: "date" },
                                { display: "报价金额", name: "报价金额", newline: false, type: "text" },
                                { display: "报价人", name: "报价人", newline: true, type: "text" },
                                { display: "审核人", name: "审核人", newline: false, type: "text" },
                                { display: "取消原因", name: "取消原因", newline: false, type: "text" },
                                { display: "出厂时间", name: "出厂时间", newline: true, type: "text" },
                                { display: "实际完工", name: "实际完工", newline: false, type: "text" },
                                { display: "出厂里程", name: "出厂里程", newline: false, type: "text" },
                                { display: "维修状态", name: "维修状态", newline: true, type: "text" },
                                //{
                                //    display: "保险公司 ", name: "保险公司", newline: false, type: "combobox",
                                //    options: {
                                //        valueField: '名称',
                                //        textField: '名称',
                                //        autocomplete: true,
                                //        url: '/index.php?g=Query&m=Consume&a=baoxian',
                                //    } },
                                
                                { display: "报称故障 ", name: "报称故障", newline: true,width: 470,type: "textarea" },
                                { display: "重要提示 ", name: "重要提示", newline: true, width: 470, type: "textarea" },
                                { display: "备注 ", name: "备注", newline: true, width: 470, type: "textarea" },
                            ]

                        },
                        {
                            title: '维修项目'
                        },
                        {
                            title: '维修配件'
                        },
                        {
                            title: '附加费用'
                        },
                        {
                            title: '结算信息',
                            fields: [
                                {display:'结算客户',name:'结算客户',newline:true,type:'text'},
                                {display:'三包厂商',name:'三包厂商',newline:false,type:'text'},
                                { display: '保险公司', name: '保险公司', newline: false, type: 'text' },
                                {display:'服务折扣',name:'服务折扣',newline:true,type:'text'},
                                { display: '销售折扣', name: '销售折扣', newline: false, type: 'text' },
                                { display: '费用折扣', name: '费用折扣', newline: false, type: 'text' },
                                {display:'服务税率',name:'服务税率',newline:true,type:'text'},
                                { display: '销售税率', name: '销售税率', newline: false, type: 'text' },
                                { display: '费用税率', name: '费用税率', newline: false, type: 'text' },
                                {display:'计次金额',name:'计次金额',newline:true,type:'text'},
                                { display: '材料费', name: '材料费', newline: false, type: 'text' },
                                { display: '管理费', name: '管理费', newline: false, type: 'text' },
                                {display:'工时费',name:'工时费',newline:true,type:'text'},
                                { display: '附加费', name: '附加费', newline: false, type: 'text' },
                                { display: '款项总额', name: '款项总额', newline: false, type: 'text' },
                                {display:'三包金额',name:'三包金额',newline:true,type:'text'},
                                { display: '保险金额', name: '保险金额', newline: false, type: 'text' },
                                { display: '保险客付', name: '保险客付', newline: false, type: 'text' },
                                {display:'客付金额',name:'客付金额',newline:true,type:'text'},
                                { display: '客付税额', name: '客付税额', newline: false, type: 'text' },
                                { display: '客付虚增', name: '客付虚增', newline: false, type: 'text' },
                                {display:'优惠金额',name:'优惠金额',newline:true,type:'text'},
                                { display: '应收金额', name: '应收金额', newline: false, type: 'text' },
                                { display: '现收金额', name: '现收金额', newline: false, type: 'text' },
                                {display:'预存结算',name:'预存结算',newline:true,type:'text'},
                                { display: '代币券结算', name: '代币券结算', newline: false, type: 'text' },
                                { display: '兑现金额', name: '兑现金额', newline: false, type: 'text' },
                                {display:'使用积分',name:'使用积分',newline:true,type:'text'},
                                { display: '发票类型', name: '发票类型', newline: false, type: 'text' },
                                { display: '发票号码', name: '发票号码', newline: false, type: 'text' },
                                {display:'结算日期',name:'结算日期',newline:true,type:'text'},
                                { display: '结算方式', name: '结算方式', newline: false, type: 'text' },
                                { display: '结算人', name: '结算人', newline: false, type: 'text' },
                                { display: '毛利', name: '毛利', newline: true, type: 'text' },

                            ]
                                                             
                        },
                        {
                            title: '车辆图片'
                        },
                        {
                            title: '操作日志'
                        }
                    ]
                }

            });
           
            setdata();
            function submitForm() {

                var form = liger.get("form1");
                var data = form.getData();
                data = JSON2.stringify(data);
                alert(data);
                data = JSON2.parse(data);

                //$.post('/index.php?g=Query&m=Consume&a=carinfo', data,
                //  function (msg) {
                //      alert(msg);
                //      location.href = location.href;
                //  });

            }

            function getGridOptions(checkbox) {
                var options = {
                    columns: [
                    { display: '车主名称', name: '名称', align: 'left', width: 100, minWidth: 60 },
                    { display: '会员编号', name: '会员编号', minWidth: 120, width: 100 },
                    { display: '等级', name: '等级', minWidth: 120, width: 100 },
                    { display: '联系人', name: '联系人', minWidth: 140, width: 100 },
                    { display: '联系电话', name: '联系电话', width: 100 },
                    { display: '手机号码', name: '手机号码', width: 100 },
                    { display: '业务员', name: '业务员', width: 100 }
                    ],
                    switchPageSizeApplyComboBox: false,
                    url:'/index.php?g=Query&m=Consume&a=getuserinfo',
                    //data: $.extend({}, {}),
                    pageSize: 10,
                    checkbox: checkbox                   
                };
                return options;
            }            function todate(num) {
                if (num && num.length > 8) {
                    num = num + "";
                    var date = "";
                    var month = new Array();
                    month["Jan"] = '01'; month["Feb"] = '02'; month["Mar"] = '03'; month["Apr"] = '04'; month["May"] = '05'; month["Jan"] = '06';
                    month["Jul"] = '07'; month["Aug"] = '08'; month["Sep"] = '09'; month["Oct"] = '10'; month["Nov"] = '11'; month["Dec"] = '12';
                    str = num.split(" ");
                    date = str[2] + "-";
                    date = date + month[str[0]] + "-" + str[1];
                    var times = str[3].split(':');
                    time = times[0] + ':' + times[1];
                    if (times[2].indexOf('PM')) {
                        time = (parseInt(time[0]) + 12) + ':' + times[1];
                    }
                    return date + ' ' + time;
                }
                return num;
            }
            function setdata()
            {
                var carinfo ={pigcms:$carinfo};
                if (carinfo && carinfo != '') {
                    carinfo = JSON2.stringify(carinfo);
                    carinfo = JSON2.parse(carinfo);
                    form.setData(carinfo);
                    $("input[ligeruiid='车主']").val(carinfo['车主']);
                    $("input[ligeruiid='车型']").val(carinfo['车型']);
                    $("input[ligeruiid='客户类别']").val(carinfo['客户类别']);
                    $("input[ligeruiid='品牌']").val(carinfo['品牌']);
                    $("input[ligeruiid='车辆类别']").val(carinfo['车辆类别']);
                    $("input[ligeruiid='颜色']").val(carinfo['颜色']);
                    $("input[ligeruiid='外观']").val(carinfo['外观']);
                    $("input[ligeruiid='保险公司']").val(carinfo['保险公司']);
                    $("input[ligeruiid='服务顾问']").val(carinfo['服务顾问']);

                    $("div[data-index='1']").html("<div id='projectgrid' style='margin:0;padding 0'><div>");
                    $("div[data-index='2']").html("<div id='productgrid'style='margin:0;padding 0'><div>");
                    $("div[data-index='3']").html("<div id='appendgrid'style='margin:0;padding 0'><div>");
                    $("div[data-index='6']").html("<div id='opgrid'style='margin:0;padding 0'><div>");
                    $("div[data-index='5']").html('<div class="l-form-container"><iframe frameborder="0" width="100%" height="500px" src="/index.php?g=Query&m=Consume&a=fileupload&carno=' + carinfo['流水号'] + '"></iframe></div>');

                    var project=$("#projectgrid").ligerGrid({
                        height: '100%',
                        width: '100%',
                        columns: [
                        {
                            display: '是否同意', name: '是否同意', align: 'left', width: 100, minWidth: 60, render: function (rowdata, index, value) {
                                if (value == '1')
                                    return '是';
                                return '否';
                            }
                        },
                        { display: '已维修', name: '已维修', minWidth: 120 },
                        { display: '项目编号', name: '项目编号', minWidth: 140 },
                        { display: '项目名称', name: '项目名称', minWidth: 120 },
                        { display: '主修人', name: '主修人', minWidth: 120 },
                        { display: '班组', name: '班组', minWidth: 120 },
                        { display: '开工时间', name: '开工时间', type: 'date', minWidth: 120, render: format },
                        { display: '完工时间', name: '完工时间', type: 'date', minWidth: 120, render: format },
                        { display: '维修工艺', name: '维修工艺', minWidth: 120 },
                        { display: '结算方式', name: '结算方式', minWidth: 120 },
                        { display: '工时', name: '工时', minWidth: 120 },
                        { display: '单价', name: '单价', minWidth: 120 },
                        { display: '金额', name: '金额', minWidth: 120 },
                        { display: '折扣', name: '折扣', minWidth: 120 },
                        { display: '税率', name: '税率', minWidth: 120 },
                        { display: '税额', name: '税额', minWidth: 120 },
                        { display: '虚增类别', name: '虚增类别', minWidth: 120 },
                        { display: '虚增金额', name: '虚增金额', minWidth: 120 },
                        { display: '提成工时', name: '提成工时', minWidth: 120 }, 
                        { display: '提成金额', name: '提成金额', minWidth: 120 },
                        { display: '维修工扣款', name: '维修工扣款', minWidth: 120 },
                        { display: '扣款原因', name: '扣款原因', minWidth: 120 },
                        { display: '备注', name: '备注', minWidth: 240 }
                        ],
                        url: '/index.php?g=Query&m=Consume&a=getproject',
                        pageSize: 10,
                        isScroll: true,
                        delayLoad: true,
                        checkbox:true,
                        urlParms: { id: carinfo['ID'] },
                        rownumbers: true,
                        toolbar: {
                            items: [
                            {
                                text: '增加',
                                click: function () {
                                    alert('1');
                                }, icon: 'add'
                            },
                            { line: true },
                            { text: '派工', click: null, icon: 'memeber' },
                            { line: true },
                            { text: '修改', click: null, icon: 'modify' },
                            { line: true },
                            { text: '删除', click: null, icon: 'delete' }
                            ]
                        }
                    });                    $("li[data-index='1']").live('click', function () {
                        project.reload();
                    });

                    var product=$("#productgrid").ligerGrid({
                        height: '100%',
                        columns: [
                        { display: '是否同意', name: '是否同意', align: 'left', width: 100, minWidth: 60 },
                        { display: '仓库', name: '仓库', minWidth: 120 },
                        { display: '编号', name: '编号', minWidth: 140 },
                        { display: '名称', name: '名称', minWidth: 120},
                        { display: '规格', name: '规格', minWidth: 120 },
                        { display: '单位', name: '单位', minWidth: 120 },
                        { display: '结算类别', name: '结算类别', minWidth: 120},
                        { display: '数量', name: '数量', type: 'date', minWidth: 120},
                        { display: '已领料数量', name: '已领料数量', minWidth: 120 },
                        { display: '已退料数量', name: '已退料数量', minWidth: 120 },
                        { display: '单价', name: '单价', minWidth: 120 },
                        { display: '金额', name: '金额', minWidth: 120 },
                        { display: '折扣', name: '折扣', minWidth: 120 },
                        { display: '税率', name: '税率', minWidth: 120 },
                        { display: '税额', name: '税额', minWidth: 120 },
                        { display: '虚增类别', name: '虚增类别', minWidth: 120 },
                        { display: '虚增金额', name: '虚增金额', minWidth: 120 },
                        { display: '急件金额', name: '急件金额', minWidth: 120 },
                        { display: '适用车型', name: '适用车型', minWidth: 120 },
                        { display: '产地', name: '产地', minWidth: 120 },
                        { display: '备注', name: '备注', minWidth: 240 }
                        ],
                        url: '/index.php?g=Query&m=Consume&a=getproduct',
                        pageSize: 10,
                        isScroll: true,
                        delayLoad: true,
                        urlParms:{id:carinfo['ID']},
                        rownumbers: true,
                        toolbar: {
                        items: [
                        { text: '增加', click:null , icon: 'add' },
                        { line: true },
                        { text: '修改', click:null , icon: 'modify' },
                        { line: true },
                        { text: '删除', click:null , icon: 'delete' }
                        ]
                    }
                    });                    $("li[data-index='2']").live('click', function () {
                        product.reload();
                    });                    var append=$("#appendgrid").ligerGrid({
                        height: '100%',
                        columns: [
                        { display: '是否同意', name: '是否同意', align: 'left', width: 100, minWidth: 60 },
                        { display: '编号', name: '编号', minWidth: 140 },
                        { display: '名称', name: '名称', minWidth: 120},
                        { display: '结算方式', name: '结算方式', minWidth: 120},
                        { display: '金额', name: '金额', minWidth: 120 },
                        { display: '折扣', name: '折扣', minWidth: 120 },
                        { display: '税率', name: '税率', minWidth: 120 },
                        { display: '税额', name: '税额', minWidth: 120 },
                        { display: '托外单位', name: '托外单位', minWidth: 120 },
                        { display: '托外金额', name: '托外金额', minWidth: 120 },
                        { display: '付款金额', name: '付款金额', minWidth: 120 },
                        { display: '备注', name: '备注', minWidth: 240 }
                        ],
                        url: '/index.php?g=Query&m=Consume&a=getappend',
                        pageSize: 10,
                        isScroll: true,
                        delayLoad: true,
                        urlParms:{id:carinfo['ID']},
                        rownumbers: true,
                        toolbar: {
                            items: [
                            { text: '增加', click:null , icon: 'add' },
                            { line: true },
                            { text: '修改', click:null , icon: 'modify' },
                            { line: true },
                            { text: '删除', click:null , icon: 'delete' }
                            ]
                        }
                    });                    $("li[data-index='3']").live('click', function () {
                        append.reload();
                    });                                       var opgrid = $("#opgrid").ligerGrid({
                        height: '100%',
                        columns: [
                        { display: '单据编号', name: '单据编号', align: 'left', width: 140, minWidth: 60 },
                        { display: '单据类别', name: '单据类别', minWidth: 140 },
                        { display: '时间', name: '时间', minWidth: 150,render: format },
                        { display: '操作员', name: '操作员', minWidth: 150 },
                        { display: '事件', name: '事件', minWidth: 200 }
                        ],     
                        url: '/index.php?g=Query&m=Consume&a=getlog',
                        pageSize: 10,
                        isScroll: true,
                        urlParms: { id: carinfo['业务编号'] },
                        rownumbers: true,
                    });            }
            }
            function format(rowdata, index, value) {
                return todate(value);
            }
        });


    </script>
</head>

<body style="padding:10px">
    <div id="form1">
    </div>
</body>
</html>
