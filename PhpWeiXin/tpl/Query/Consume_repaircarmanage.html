<!doctype html>
<html style="margin:0px;padding:0px">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>爱养车</title>
    <meta name="description" content="爱养车">
    <script src="/tpl/static/lib/jquery/jquery-1.9.0.min.js" type="text/javascript"></script>
    <script src="/tpl/static/lib/ligerUI/js/ligerui.min.js" type="text/javascript"></script>
    <script src="/tpl/static/lib/json2.js" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/amazeui/2.7.0/css/amazeui.min.css" />
    <link rel="stylesheet" href="/tpl/static/assets/css/admin.css">
    <link href="/tpl/static/lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <link href="/tpl/static/lib/ligerUI/skins/ligerui-icons.css" rel="stylesheet" type="text/css" />
    <link href="/tpl/static/lib/ligerUI/skins/Gray2014/css/all.css" rel="stylesheet" />
    <link href="//at.alicdn.com/t/font_1477193360_4766667.css" rel="stylesheet" type="text/css" />
</head>
<body style="margin:0px;padding:0px;margin-top:0px">
    <div class="am-cf admin-main" style="padding:0;margin:0">
        <!-- content start -->
        <div class="admin-content">
            <div class="admin-content-body">
                <div style="margin:0px;padding:0px;padding-left:10px">
                    <!--<button type="button" class="am-btn am-btn-primary am-btn-sm" onclick="washcar();"><i class="iconfont icon-xiche"></i>洗车</button>-->
                    <button type="button" class="am-btn am-btn-primary am-btn-sm" onclick="meirong();"><i class="iconfont icon-meirong"></i>美容</button>
                    <button type="button" class="am-btn am-btn-primary am-btn-sm" onclick="weixiu();"><i class="iconfont icon-weixiu"></i>维修</button>
                    <button type="button" id="baojia" class="am-btn am-btn-default am-btn-sm">报价</button>
                    <button type="button" id="paigong" class="am-btn am-btn-primary am-btn-sm">派工</button>
                    <button type="button" id="lingliao" class="am-btn am-btn-secondary am-btn-sm">领料</button>
                    <button type="button" id="shenhe" class="am-btn am-btn-success am-btn-sm">审核</button>
                    <button type="button" id="jiesuan" class="am-btn am-btn-warning am-btn-sm">结算</button>
                    <button type="button" id="chuchang" class="am-btn am-btn-danger am-btn-sm">出厂</button>
                    <button type="button" id="all" class="am-btn am-btn-primary am-btn-sm">所有未结算</button>
                </div>
                <div class="am-g">
                    <div class="am-u-sm-8 am-u-md-8">
                        门店
                        <select id="shop">
                            <option value="">所有门店</option>
                        </select>
                        类别
                        <select id="lb">
                            <option value="">所有分类</option>
                            <!--<option value="蜡水洗车">蜡水洗车</option>-->
                            <option value="汽车美容">汽车美容</option>
                            <option value="普通快修">普通快修</option>
                            <option value="常规保养">常规保养</option>
                            <option value="保险理赔">保险理赔</option>
                            <option value="汽车维修">汽车维修</option>
                        </select>
                        <input type="text" id="searchkey">
                        <button id="search" type="button">模糊查询</button>
                    </div>
                    <div class="am-u-sm-4 am-u-md-4" id="optdiv">
                        <div id="baojiadiv"  style="display:none"><button type="button" onclick="changeState('派工', '派工', 'paigong');" class="am-btn am-btn-primary am-round am-btn-sm"><i class="am-icon-hand-o-right"></i>主管派工</button>
                        </div>
                        <div id="paigongdiv" style="display:none">
                            <button type="button" class="am-btn am-btn-warning am-round am-btn-sm" onclick="changeState('派工','报价','baojia');" ><i class="am-icon-hand-o-left"></i>维修报价</button>
                            <button type="button" class="am-btn am-btn-secondary am-round am-btn-sm" onclick="changeState('派工','领料','lingliao');"><i class="am-icon-hand-o-right"></i>维修领料</button>
                        </div>
                        <div id="lingliaodiv"  style="display:none">
                            <button type="button" class="am-btn am-btn-warning am-round am-btn-sm" onclick="changeState('领料', '派工', 'paigong');"><i class="am-icon-hand-o-left"></i>主管派工</button>
                            <button type="button" class="am-btn am-btn-secondary am-round am-btn-sm" onclick="changeState('领料','审核','shenhe');"><i class="am-icon-hand-o-right"></i>完工审核</button>
                        </div>
                        <div id="shenhediv"  style="display:none">
                            <button type="button" class="am-btn am-btn-warning am-round am-btn-sm" onclick="changeState('审核', '派工', 'paigong');"><i class="am-icon-hand-o-left"></i>驳回派工</button>
                            <button type="button" class="am-btn am-btn-secondary am-round am-btn-sm" onclick="changeState('审核','结算','jiesuan');"><i class="am-icon-hand-o-right"></i>维修结算</button>
                        </div>
                        <div id="jiesuandiv"  style="display:none">
                            <button type="button" class="am-btn am-btn-warning am-round am-btn-sm" onclick="changeState('结算', '审核', 'shenhe');"><i class="am-icon-hand-o-left"></i>完工审核</button>
                            <!--<button type="button" class="am-btn am-btn-secondary am-round am-btn-sm" onclick="changeState('结算','出厂','chuchang');"><i class="am-icon-hand-o-right"></i>车辆出厂</button>-->
                            <button type="button" class="am-btn am-btn-secondary am-round am-btn-sm" onclick="checkin();"><i class="am-icon-check"></i>确认结算</button>
                       </div>
                        <div id="chuchangdiv"  style="display:none">
                            <!--<button type="button" class="am-btn am-btn-warning am-round am-btn-sm" onclick="changeState('出厂', '结算', 'jiesuan');"><i class="am-icon-hand-o-left"></i>维修结算</button>-->
                            <button type="button" class="am-btn am-btn-secondary am-round am-btn-sm" onclick="changeState('出厂','结束','baojia');"><i class="am-icon-hand-o-right"></i>确认出厂</button>
                        </div>
                    </div>
                </div>
                <div id="maingrid4" style="margin:0; padding:0;"></div>
                <div id="form1">
                </div>
                </div>
            </div>
        </div>
        <!-- content end -->
    </div>
    <a href="#" class="am-icon-btn am-icon-th-list am-show-sm-only admin-menu" data-am-offcanvas="{target: '#admin-offcanvas'}"></a>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/amazeui/2.7.0/js/amazeui.min.js"></script>
    <script src="/tpl/static/assets/js/app.js"></script>
    <script>
        var row,form, grid, project, product, append, opgrid, historygrid = null;
        var printdialog,washdialog, caldialog, mrdialog, wxdialog, pickdialog,
            cardialog, purchasedialog, addprojectdialog, editprojectdialog,
            memberdialog, addproductdialog,editproductdialog, assigntaskdialog, backpickdialog;
        var record, discount = {};
        function editproject() {
            if (record['当前状态'] == '结束') {
                $.ligerDialog.alert('结束状态不能修改项目信息');
                return;
            }
            var row = project.getSelectedRow();
            if (row) {
                if (editprojectdialog) {
                    editprojectdialog.setUrl('index.php?&g=Query&m=Consume&a=modifyproject&id=' + row['流水号']);
                    editprojectdialog.show();
                } else {
                    editprojectdialog = $.ligerDialog.open({
                        height: 400,
                        url: 'index.php?&g=Query&m=Consume&a=modifyproject&id=' + row['流水号'],
                        width: 600,
                        showMax: true,
                        showToggle: true,
                        showMin: false,
                        isResize: true,
                        modal: true,
                        title: '修改维修项目'
                    });
                }
            }
            else {
                $.ligerDialog.alert('请选择要修改的项目');
            }

        }
        function editproduct() {
            if (record['当前状态'] == '结束') {
                $.ligerDialog.alert('结束状态不能修改配件信息');
                return;
            }
            var row = product.getSelectedRow();
            if (row) {
                if (editproductdialog) {
                    editproductdialog.setUrl('index.php?&g=Query&m=Consume&a=modifyproduct&id=' + row['流水号']);
                    editproductdialog.show();
                } else {
                    editproductdialog = $.ligerDialog.open({
                        height: 420,
                        url: 'index.php?&g=Query&m=Consume&a=modifyproduct&id=' + row['流水号'],
                        width: 600,
                        showMax: true,
                        showToggle: true,
                        showMin: false,
                        isResize: true,
                        modal: true,
                        title: '编辑配件'
                    });
                }
            }
            else {
                $.ligerDialog.alert('请选择要修改的配件');
            }

        }
        function printbill(ID) {
            if (printdialog) {
                printdialog.setUrl('/index.php?g=Query&m=Consume&a=printbill&ID=' + ID);
                printdialog.show();
            } else {
                printdialog = $.ligerDialog.open({
                    height: 600,
                    url: '/index.php?g=Query&m=Consume&a=printbill&ID=' + ID,
                    width: 950,
                    showMax: true,
                    showToggle: true,
                    showMin: true,
                    isResize: true,
                    modal: false,
                    title: '打印结算单'
                });
            }
        }
        function addproduct(rowid) {
            for (var i = 0; i < grid.data.Rows.length; i++) {
                if (grid.data.Rows[i]['流水号'] == rowid) {
                    record = grid.data.Rows[i];

                }
            }
            if (record['当前状态'] == '结束') {
                $.ligerDialog.alert('结束状态不能增加维修项目');
                return;
            }
            var c = 1;
            if (discount && discount['销售折扣1'] != null) {
                c = discount['销售折扣1'];
            }
            var url = 'index.php?&g=Query&m=Consume&a=addproduct&itemID=' + record['流水号'] + '&ID=' + record['ID'] + "&discount=" + c + "&shop=" + record['门店'];
           if (addproductdialog) {
                addproductdialog.setUrl(url);
                addproductdialog.show();
            } else {
                addproductdialog = $.ligerDialog.open({
                    height: 600,
                    url: url,
                    width: 900,
                    showMax: true,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: true,
                    title: '增加维修配件'
                });

            }
        }
        function addproject(rowid) {
            for (var i = 0; i < grid.data.Rows.length; i++) {
                if (grid.data.Rows[i]['流水号'] == rowid) {
                    record=grid.data.Rows[i];

                }
            }
            if (record['当前状态'] == '结束') {
                $.ligerDialog.alert('结束状态不能增加维修项目');
                return;
            }
            var c = 1;
            if (discount&&discount['服务折扣1'] != null) {
                c = discount['服务折扣1'];
            }
            var url='index.php?&g=Query&m=Consume&a=addproject&itemID=' + record['流水号'] + '&ID=' + record['ID'] + "&discount=" + c + "&zhuxiu=" + record['当前主修人'];
            if (addprojectdialog) {
                addprojectdialog.setUrl(url);
                addprojectdialog.show();
            } else {
                addprojectdialog = $.ligerDialog.open({
                    height: 600,
                    url: url,
                    width: 900,
                    showMax: true,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: true,
                    title: '增加维修项目'
                });

            }
        }
        function wxinfo(xh) {
           var wxdialog= $.ligerDialog.open({
                height: 540,
                url: '/index.php?g=Query&m=Consume&a=wxinfo&xh=' + xh,
                width: 950,
                showMax: true,
                showToggle: true,
                showMin: false,
                isResize: true,
                modal: false,
                title: '车辆维修详细信息'
           });
        }
        function pick() {
            if (record['当前状态'] == '结束') {
                $.ligerDialog.alert('结束状态不能领料');
                return;
            }
            if (pickdialog) {
                pickdialog.setUrl('/index.php?g=Query&m=Consume&a=picking');
                pickdialog.show();
            }
            else {
                  pickdialog = $.ligerDialog.open({
                    height: 540,
                    url: '/index.php?g=Query&m=Consume&a=picking',
                    width: 800,
                    showMax: true,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: true,
                    title: '维修领料'
                });
            }
        }
        function backpick() {
            if (record['当前状态'] == '结束') {
                $.ligerDialog.alert('结束状态不能退料');
                return;
            }
            if (backpickdialog) {
                backpickdialog.setUrl('/index.php?g=Query&m=Consume&a=backpick');
                backpickdialog.show();
            }
            else {
                backpickdialog = $.ligerDialog.open({
                    height: 540,
                    url: '/index.php?g=Query&m=Consume&a=backpick',
                    width: 800,
                    showMax: true,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: true,
                    title: '维修领料'
                });
            }
        }
        function memberinfo(carno) {
            if (memberdialog) {
                memberdialog.setUrl('/index.php?g=Query&m=Consume&a=memberinfo&carno=' + carno);
                memberdialog.show();
            }
            else {
                memberdialog = $.ligerDialog.open({
                    height: 500,
                    url: '/index.php?g=Query&m=Consume&a=memberinfo&carno=' + carno,
                    width: 900,
                    showMax: true,
                    showToggle: true,
                    showMin: true,
                    isResize: true,
                    modal: false,
                    title: '会员资料编辑'
                });
            }
        }
        function checkin() {
            var row = grid.getSelectedRow();
            if (row['当前状态'] == '结束') {
                $.ligerDialog.alert('不要重复结算');
                return;
            }
            if (row) {
                if (caldialog) {
                    caldialog.setUrl('/index.php?g=Query&m=Consume&a=pay');
                    caldialog.show();
                }
                else {
                    caldialog = $.ligerDialog.open({
                        height: 340,
                        url: '/index.php?g=Query&m=Consume&a=pay',
                        width: 600, 
                        showMax: false,
                        showToggle: true,
                        showMin: false,
                        isResize: true,
                        modal: false,
                        title: '结算信息'
                    });
                }

            }
            else {
                $.ligerDialog.alert('选择要结算的维修记录');
            }
        }
        function purchasing() {
            if (record['当前状态'] == '结束')
            {
                $.ligerDialog.alert('结束状态不能开采购单');
                return;
            }
            if (purchasedialog) {
                purchasedialog.setUrl('/index.php?g=Query&m=Consume&a=purchasing');
                purchasedialog.show();
            }
            else {
                purchasedialog = $.ligerDialog.open({
                    height: 540,
                    url: '/index.php?g=Query&m=Consume&a=purchasing',
                    width: 800,
                    showMax: true,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: true,
                    title: '维修采购开单'
                });
            }
        }
        function viewcarinfo(carno) {
            if (cardialog) {
                cardialog.setUrl('/index.php?g=Query&m=Consume&a=carinfo&carno=' + carno);
                cardialog.show();
            }
            else {
                    cardialog = $.ligerDialog.open({
                    height: 500,
                    url: '/index.php?g=Query&m=Consume&a=carinfo&carno=' + carno,
                    width: 900,
                    showMax: true,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: true,
                    title: '车辆信息编辑'
                });
            }
        }
        function meirong() {
            if (mrdialog) mrdialog.show();
            else {
                mrdialog = $.ligerDialog.open({
                    height: 350,
                    url: '/index.php?g=Query&m=Consume&a=meirong',
                    width: 600,
                    showToggle: false,
                    showMin: false,
                    isResize: true,
                    modal: true,
                    title: '美容录入'
                });
            }
        }
        function weixiu() {
            if (wxdialog) wxdialog.show();
            else {
                wxdialog = $.ligerDialog.open({
                    height: 480,
                    url: '/index.php?g=Query&m=Consume&a=wxrecord',
                    width: 600,
                    showToggle: false,
                    showMin: false,
                    isResize: true,
                    modal: true,
                    title: '维修录入'
                });
            }
        }
        function assigntask() {
            var row =  project.getSelected();
            if (row) {
                var url = '/index.php?g=Query&m=Consume&a=assigntask';
                url += '&id=' + record['ID'];
                url += '&shop=' + record['门店'];
                url += '&wxlb=' + record['维修类别'];
                url += '&code=' + row['流水号'];

                if (assigntaskdialog) {
                    assigntaskdialog.setUrl(url);
                    assigntaskdialog.show();
                }
                else {
                    assigntaskdialog = $.ligerDialog.open({
                        height: 180,
                        url: url,
                        width: 280,
                        showMax: false,
                        showToggle: true,
                        showMin: true,
                        isResize: true,
                        modal: true,
                        title: '派工'
                    });
                }
            }
            else {
                $.ligerDialog.alert('请选择要派工的项目');
            }
        }
        function submitcarkey(itemid) {
            $.ligerDialog.prompt('输入钥匙扣编号', function (yes, value) {
                if (yes) {
                    if (value == null || value == "") {
                        $.ligerDialog.alert('钥匙扣编号为空');
                        return;
                    }
                    var data = {
                        itemid: itemid,
                        keynum: value

                    };
                    $.post('/index.php?g=Query&m=Consume&a=submitcarkey', data,
                      function (msg) {
                          $.ligerDialog.alert(msg);
                          grid.reload();
                      });
                }
            });
        }
        function completework(itemid) {
            var data = {
                itemid: itemid,
            };
            $.post('/index.php?g=Query&m=Consume&a=completework', data,
              function (msg) {
                  $.ligerDialog.alert(msg);
                  grid.reload();
              });
        }
        function cancelwash(itemid, flag) {
            var data = {
                itemid: itemid,
            };
            $.post('/index.php?g=Query&m=Consume&a=cancelwash', data,
              function (msg) {
                  if (flag) {
                      $.ligerDialog.alert(msg);
                      grid.reload();
                  }
              });
        }
        function checkin(code) {
            if (caldialog) {
                caldialog.setUrl('/index.php?g=Query&m=Consume&a=newpay');
                caldialog.set('code', code);
                caldialog.show();
            }
            else {
                caldialog = $.ligerDialog.open({
                    height: 340,
                    url: '/index.php?g=Query&m=Consume&a=newpay',
                    width: 600,
                    showMax: false,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: false,
                    code: code,
                    title: '结算信息'
                });
            }
        }
        function assignbatchtask(id, shop, wxlb) {
            var url = '/index.php?g=Query&m=Consume&a=assigntask';
            url += '&id=' + id;
            url += '&shop=' + shop;
            url += '&wxlb=' + wxlb;

            if (assigntaskdialog) {
                assigntaskdialog.setUrl(url);
                assigntaskdialog.show();
            }
            else {
                assigntaskdialog = $.ligerDialog.open({
                    height: 220,
                    url: url,
                    width: 300,
                    showMax: false,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: true,
                    title: '派工'
                });
            }
        }
        function changeState(oldzt,zt, opt) {
            row = grid.getSelectedRow();
            if (row) {
                var data = {
                    id: row['流水号'],
                    zt: zt,
                    oldzt:oldzt
                };
                $.post('/index.php?g=Query&m=Consume&a=changestate', data,
                  function (msg) {
                      if (msg == '1') {
                          $('#' + opt).click();
                      }
                      else {
                          $.ligerDialog.alert(msg);
                      }
                      });
                  
            }
        }

        $(function () {
            $.post('/index.php?g=Query&m=Consume&a=getshoplist', null, function (data) {
                if (data) {
                    $('#shop').empty();
                    $('#shop').append("<option value=''>所有门店</option>");
                    $(data).each(function () {
                        var option = "<option value='" + this.名称 + "'>" + this.名称 + "</option>";
                        $('#shop').append(option);
                    });
                }
            },'JSON');
            grid = $("#maingrid4").ligerGrid({
                columns: [
                 {
                     display: '操作', name: '操作', minWidth: 85, render: function (rowdata, index, value) {
                         var strhtml = '';
                         if (rowdata.当前状态 == '报价') {
                             strhtml += '|<a href="javascript:void(0);" onclick="addproject(\'' + rowdata.流水号 + '\');"><strong>项目</strong></a>';
                             strhtml += '|<a href="javascript:void(0);" onclick="addproduct(\'' + rowdata.流水号 + '\');"><strong>配件</strong></a>';
                         }
                         if (rowdata.上交钥匙 == "" || rowdata.上交钥匙 == null || rowdata.上交钥匙 == "null" || todate(rowdata.上交钥匙, false) == '1900-01-1') {
                             var start = new Date(Date.parse(todate(rowdata.进厂时间, true)));
                             var end = new Date();
                             if (parseInt((end - start) / 60000) > 30) {
                                 //cancelwash(rowdata.流水号, false);
                             } else {
                                 strhtml += '<a href="javascript:void(0);" onclick="changeState(\'' + rowdata.流水号 + '\');"><strong>钥匙上交</strong></a>|';
                             }
                         }
                         if (rowdata.当前状态 == '派工') {
                             if (rowdata.开工时间 == "" || rowdata.开工时间 == null || rowdata.开工时间 == "null" || todate(rowdata.开工时间, false) == '1900-01-1') {
                                strhtml += '|<a href="javascript:void(0);" onclick="assignbatchtask(\'' + rowdata.ID + '\',\'' + rowdata.门店 + '\',\'' + rowdata.维修类别 + '\');"><strong>派工</strong></a>';
                             }

                         }
                         if (rowdata.当前状态 == '审核') {
                             if (rowdata.实际完工 != "" && rowdata.实际完工 != null && rowdata.实际完工 != "null" && todate(rowdata.实际完工, false) != '1900-01-1') {
                                 strhtml += '<a href="javascript:void(0);" onclick="completework(\'' + rowdata.流水号 + '\');"><strong>完工</strong></a>';
                             }
                         }
                         if (rowdata.当前状态 == '结算' && rowdata.当前状态.标志 !='已结算')
                             strhtml += '<a href="javascript:void(0);" onclick="checkin(\'' + rowdata.流水号 + '\');"><strong>结算</strong></a>';
                         if (rowdata.当前状态=='出厂')
                             strhtml += '<a href="javascript:void(0);" onclick="changeState(\'' + rowdata.流水号 + '\');"><strong>出厂</strong></a>';
                         if (rowdata.当前状态 == '结束')
                             strhtml += '<a href="javascript:void(0);" onclick="printbill(\'' + rowdata.ID + '\');"><strong>打印</strong></a>';
                         return strhtml;
                     }
                 },
                { display: '当前状态', name: '当前状态', align: 'left', width: 60 },
                {
                    display: '制单日期', name: '制单日期', minWidth: 100, render: function (rowdata, index, value) {
                        return todate(value, false);
                    }
                },
                {
                    display: '已处理', name: '', minWidth: 80, render: function (rowdata, index, value) {
                        if (rowdata.进厂时间 != "" && rowdata.进厂时间 != null && rowdata.进厂时间 != "null" && todate(rowdata.进厂时间, false) != '1900-01-1') {
                            var start = new Date(Date.parse(todate(rowdata.进厂时间, true)));
                            if (rowdata.实际完工 != null && rowdata.实际完工 != "" && rowdata.实际完工 != "null" && todate(rowdata.实际完工, false) != '1900-01-1') {
                                end = new Date(Date.parse(todate(rowdata.实际完工, true)));
                                return ((end - start) / 60000 / 60).toFixed(2) + '小时';
                            }
                            else {
                                var end = new Date();
                                return ((end - start) / 60000 / 60).toFixed(2) + '小时';
                            }
                        }
                        return '';
                    }
                },

                { display: '主修人', name: '主修人', width: 60, align: 'left' },
                {
                    display: '客户确认', name: '确认维修', align: 'center', width: 50, render: function (rowdata, index, value) {
                        if (value == null || value == '')
                            value = '<span style="color:red">否</span>';
                        else
                            value = '<span style="color:blue">是</span>';

                        return value;
                    }
                },
                { display: '制单人', name: '制单人', width: 60, align: 'left' },
                { display: '接车人', name: '接车人', minWidth: 60 },
                { display: '维修类别', name: '维修类别', minWidth: 80 },
                {
                    display: '车牌号码', name: '车牌号码', minWidth: 100, render: function (rowdata, index, value) {

                        return '<a href="javascript:void(0);" onclick="viewcarinfo(\'' + value + '\');"><strong>' + value + '</strong></a>';

                    }
                },
                {
                    display: '车主', name: '车主', minWidth: 140, render: function (rowdata, index, value) {

                        return '<a href="javascript:void(0);" onclick="memberinfo(\'' + value + '\');"><strong>' + value + '</strong></a>';

                    }
                },
                { display: '客户类别', name: '客户类别', minWidth: 140 },
                { display: '联系人', name: '联系人', minWidth: 100 },
                { display: '轮胎规格', name: '轮胎规格', minWidth: 60 },
                { display: '机油格', name: '机油格', minWidth: 60 },
                { display: '空气格', name: '空气格', minWidth: 60 },
                { display: '冷气格', name: '冷气格', minWidth: 60 },
                {
                    display: '保险到期', name: '商保到期', minWidth: 100, render: function (rowdata, index, value) {
                        return todate(value, false);
                    }
                },
                {
                    display: '操作', name: '操作', minWidth: 100, render: function (rowdata, index, value) {
                        if (rowdata['制单人'] == '系统录单' && rowdata['主修人'] == '')
                            return '<a href="javascript:void(0);" onclick="assignbatchtask(\'' + rowdata.ID + '\',\'' + rowdata['门店'] + '\',\'' + rowdata['维修类别'] + '\');"><strong>派工</strong></a>';
                        else
                            return '';
                    }
                }
                ],
                isScroll: true,
                pageSize: 15,
                pageSizeOptions: [10,15,20,30,50],
                url: '/index.php?g=Query&m=Consume&a=getwxinfo',
                height: '92%',
                onDblClickRow: function (data, rowindex, rowobj) {
                    wxinfo(data['流水号']);
                },
                onSelectRow: function (data, rowindex, rowobj) {
                    record = data;
                },
                onSuccess: function (data) {
                    //if (data.Rows) {
                    //    record = data.Rows[0];
                    //    $.getJSON('index.php?&g=Query&m=Consume&a=getdiscount&id=' + record['客户ID'], function (data) {
                    //        discount = data;
                    //   });
                    //}
                }
            });
            $("#lb").change(function () {
                $('#search').click();
            });
            $("#shop").change(function () {
                $('#search').click();
            });
            $('#baojia').click(function () {
                $('#optdiv').find('div').each(function () {
                    $(this).hide();
                });
                $('#baojiadiv').show();
                var parms = {
                    zt:'报价'
                };
                grid.set('parms', parms);
                grid.reload();
                setTimeout(function () {
                    grid.select(grid.data.Rows[0]);
                }, 800);
             

            });
            $('#paigong').click(function () {
                $('#optdiv').find('div').each(function () {
                    $(this).hide();
                });
                $('#paigongdiv').show();
                var parms = {
                    zt: '派工'
                };
                grid.set('parms', parms);
                grid.reload();
                setTimeout(function () {
                    if (row) {
                        for (var i = 0; i < grid.data.Rows.length; i++) {
                            if (grid.data.Rows[i]['流水号'] == row['流水号']) {
                                grid.select(grid.data.Rows[i]);

                            }
                        }
                    } else {
                        grid.select(grid.data.Rows[0]);
                    }
                }, 800);


            });
            $('#lingliao').click(function () {
                $('#optdiv').find('div').each(function () {
                    $(this).hide();
                });
                $('#lingliaodiv').show();
                var parms = {
                    zt: '领料'
                };
                grid.set('parms', parms);
                grid.reload();
                setTimeout(function () {
                    if (row) {
                        for (var i = 0; i < grid.data.Rows.length; i++) {
                            if (grid.data.Rows[i]['流水号'] == row['流水号']) {
                                grid.select(grid.data.Rows[i]);

                            }
                        }
                    } else {
                        grid.select(grid.data.Rows[0]);
                    }
                }, 800);

            });
            $('#shenhe').click(function () {
                $('#optdiv').find('div').each(function () {
                    $(this).hide();
                });
                $('#shenhediv').show();
                var parms = {
                    zt: '审核'
                };
                grid.set('parms', parms);
                grid.reload();
                setTimeout(function () {
                    if (row) {
                        for (var i = 0; i < grid.data.Rows.length; i++) {
                            if (grid.data.Rows[i]['流水号'] == row['流水号']) {
                                grid.select(grid.data.Rows[i]);

                            }
                        }
                    } else {
                        grid.select(grid.data.Rows[0]);
                    }
                }, 800);
            });
            $('#jiesuan').click(function () {
                $('#optdiv').find('div').each(function () {
                    $(this).hide();
                });
                $('#jiesuandiv').show();
                var parms = {
                    zt: '结算'
                };
                grid.set('parms', parms);
                grid.reload();
                setTimeout(function () {
                    if (row) {
                        for (var i = 0; i < grid.data.Rows.length; i++) {
                            if (grid.data.Rows[i]['流水号'] == row['流水号']) {
                                grid.select(grid.data.Rows[i]);

                            }
                        }
                    } else {
                        grid.select(grid.data.Rows[0]);
                    }
                }, 800);
            });
            $('#chuchang').click(function () {
                $('#optdiv').find('div').each(function () {
                    $(this).hide();
                });
                $('#chuchangdiv').show();
                setdisabled();
                var parms = {
                    zt: '出厂'
                };
                grid.set('parms', parms);
                grid.reload();
                setTimeout(function () {
                    if (row) {
                        for (var i = 0; i < grid.data.Rows.length; i++) {
                            if (grid.data.Rows[i]['流水号'] == row['流水号']) {
                                grid.select(grid.data.Rows[i]);

                            }
                        }
                    } else {
                        grid.select(grid.data.Rows[0]);
                    }
                }, 800);
            });
            $('#all').click(function () {
                var parms = {
                    zt: '',
                    type: '1'
                };
                grid.set('parms', parms);
                grid.reload();
                $('#optdiv').find('div').each(function () {
                    $(this).hide();
                });
                setTimeout(function () {
                   if (row) {
                        for (var i = 0; i < grid.data.Rows.length; i++) {
                            if (grid.data.Rows[i]['流水号'] == row['流水号']) {
                                grid.select(grid.data.Rows[i]);

                            }
                        }
                    } else {
                        grid.select(grid.data.Rows[0]);
                    }
                }, 800);
            });
            $('#search').click(function () {
                grid.changePage('first');
                var parms = {};
                var shop = $('#shop').val();
                if (shop != '')
                    parms.shop = shop;
                var lb = $('#lb').val();
                if (lb != '')
                    parms.lb = lb;
                var searchkey = $('#searchkey').val();
                if (searchkey != '')
                    parms.searchkey = searchkey;
                grid.set('parms', parms);
                grid.reload();
                setdisabled();
                $('#optdiv').find('div').each(function () {
                    $(this).hide();
                });
            });
        });
    </script>

</body>
</html>
