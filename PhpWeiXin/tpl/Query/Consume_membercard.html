<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>会员管理</title>
    <script src="/tpl/static/lib/jquery/jquery-1.9.0.min.js" type="text/javascript"></script>
    <script src="/tpl/static/lib/ligerUI/js/ligerui.min.js" type="text/javascript"></script>
    <script src="/tpl/static/lib/json2.js" type="text/javascript"></script>
    <link rel="stylesheet" href="/tpl/static/assets/css/amazeui.min.css" />
    <link rel="stylesheet" href="/tpl/static/assets/css/admin.css">
    <link href="/tpl/static/lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <link href="/tpl/static/lib/ligerUI/skins/ligerui-icons.css" rel="stylesheet" type="text/css" />
    <link href="/tpl/static/lib/ligerUI/skins/Gray2014/css/all.css" rel="stylesheet" />
    <link href="//at.alicdn.com/t/font_1477193360_4766667.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <!--[if lte IE 9]>
    <p class="browsehappy">你正在使用<strong>过时</strong>的浏览器。 请 <a href="http://browsehappy.com/" target="_blank">升级浏览器</a>
      以获得更好的体验！</p>
    <![endif]-->
    <div class="am-cf admin-main" style="padding:0;margin:0">
        <!-- content start -->
        <div class="admin-content">
            <div class="admin-content-body">
                <div class="am-g">
                    <div class="am-u-sm-2 am-u-md-2">
                        <div class="am-form-group">
                            <select id="shop">
                                <option value="">所有门店</option>
                            </select>
                        </div>
                    </div>

                    <div class="am-u-sm-6 am-u-md-6">
                        <button type="button" class="am-btn am-btn-default am-margin-right" id="my-start">开始日期</button><span id="my-startDate"></span>
                        <button type="button" class="am-btn am-btn-default am-margin-right" id="my-end">结束日期</button><span id="my-endDate"></span>
                    </div>
                    <div class="am-u-sm-4 am-u-md-4">
                        <div class="am-input-group am-input-group-sm">
                            <input type="text" id="searchkey" class="am-form-field">
                            <span class="am-input-group-btn">
                                <button id="search" class="am-btn am-btn-default" type="button">搜索</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div id="maingrid4" style="margin:0; padding:0;"></div>
            </div>
            <div class="am-modal am-modal-prompt" tabindex="-1" id="doc-modal-1">
                <div class="am-modal-dialog">
                    <div class="am-modal-hd">
                        会员充值
                        <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
                    </div>
                    <div class="am-modal-bd">
                        <div class="am-form">
                            <input type="hidden" name="uid" id='uid' value="{pigcms:$uinfo.id}" />
                            <input type="hidden" name="cardid" id='cardid' value="{pigcms:$cardid}" />
                            <div class="am-g am-margin-top">
                                <div class="am-u-sm-6 am-u-md-6 am-text-right">
                                    <span class="red">*</span>收款方式
                                </div>
                                <div class="am-u-sm-6 am-u-md-6">
                                    <select id="paytype">
                                        <option value="现金">现金</option>
                                        <option value="刷卡">刷卡</option>
                                    </select>
                                </div>
                                <div class="am-u-sm-6 am-u-md-6 am-text-right">
                                    <span class="red">*</span>充值金额(元)
                                </div>
                                <div class="am-u-sm-6 am-u-md-6">
                                    <input type="text" name="price" id="price" value="" class="am-input-sm" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="am-modal-footer">
                        <span class="am-modal-btn" data-am-modal-cancel>取消</span>
                        <span class="am-modal-btn" data-am-modal-confirm>提交</span>
                    </div>
                </div>
            </div>
            <div class="am-modal am-modal-prompt" tabindex="-1" id="doc-modal-2">
                <div class="am-modal-dialog">
                    <div class="am-modal-hd">
                        绑定车牌
                        <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
                    </div>
                    <div class="am-modal-bd">
                        <div class="am-form">
                            <input type="hidden" name="uid" id='uid' value="{pigcms:$uinfo.id}" />
                            <input type="hidden" name="cardid" id='cardid' value="{pigcms:$cardid}" />
                            <div class="am-g am-margin-top">
                                <div class="am-u-sm-6 am-u-md-6 am-text-right">
                                    <span class="red">*</span>车牌号码
                                </div>
                                <div class="am-u-sm-6 am-u-md-6">
                                    <input type="text" name="carno" id="carno" value="" class="am-input-sm" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="am-modal-footer">
                        <span class="am-modal-btn" data-am-modal-cancel>取消</span>
                        <span class="am-modal-btn" data-am-modal-confirm>提交</span>
                    </div>
                </div>
            </div>
            <div class="am-modal am-modal-prompt" tabindex="-1" id="doc-modal-3">
                <div class="am-modal-dialog">
                    <div class="am-modal-hd">
                        删除车牌
                        <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
                    </div>
                    <div class="am-modal-bd">
                        <div class="am-form">
                            <div class="am-g am-margin-top">
                                <div class="am-u-sm-4 ">
                                    <span class="red">*</span>车牌号码
                                </div>
                                <div class="am-u-sm-8 ">
                                    <select data-am-selected name="carlist" id="carlist"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="am-modal-footer">
                        <span class="am-modal-btn" data-am-modal-cancel>取消</span>
                        <span class="am-modal-btn" data-am-modal-confirm>提交</span>
                    </div>
                </div>
            </div>
            <div class="am-modal am-modal-prompt" tabindex="-1" id="doc-modal-4">
                <div class="am-modal-dialog">
                    <div class="am-modal-hd">
                        修改车牌
                        <a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a>
                    </div>
                    <div class="am-modal-bd">
                        <div class="am-form">
                            <div class="am-g am-margin-top">
                                <div class="am-u-sm-4 ">
                                    <span class="red">*</span>原车牌号码
                                </div>
                                <div class="am-u-sm-8">
                                    <select data-am-selected name="carlist1" id="carlist1">
                                    </select>
                                </div>
                            </div>
                            <div class="am-g am-margin-top">
                                <div class="am-u-sm-4">
                                    <span class="red">*</span>新车牌号码
                                </div>
                                <div class="am-u-sm-8">
                                    <input type="text" name="carno1" id="carno1" value="" class="am-input-sm" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="am-modal-footer">
                        <span class="am-modal-btn" data-am-modal-cancel>取消</span>
                        <span class="am-modal-btn" data-am-modal-confirm>提交</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- content end -->
    </div>
    <a href="#" class="am-icon-btn am-icon-th-list am-show-sm-only admin-menu" data-am-offcanvas="{target: '#admin-offcanvas'}"></a>
    <script src="/tpl/static/assets/js/amazeui.min.js"></script>
    <script src="/tpl/static/assets/js/app.js"></script>
    <script>
        var grid;
        $(document).ready(function () {
            $.post('/index.php?g=Query&m=Consume&a=getshoplist', null, function (data) {
                if (data) {
                    $('#shop').empty();
                    $('#shop').append("<option value=''>所有门店</option>");
                    $(data).each(function () {
                        var option = "<option value='" + this.名称 + "'>" + this.名称 + "</option>";
                        $('#shop').append(option);
                    });
                }
            }, 'JSON');

            $('#my-start').datepicker().on('changeDate.datepicker.amui', function (event) {
                startDate = new Date(event.date);
                $('#my-startDate').text($('#my-start').data('date'));
                $(this).datepicker('close');
            });
            $('#my-end').datepicker().on('changeDate.datepicker.amui', function (event) {
                endDate = new Date(event.date);
                $('#my-endDate').text($('#my-end').data('date'));
                $(this).datepicker('close');
            });
            grid = $("#maingrid4").ligerGrid({
                columns: [
                         { display: '门店', name: 'shop', width: 100 },
                        {
                            display: '卡号', name: 'number', align: 'left', width: 110, render: function (rowdata, index, value) {

                            return '<a href="javascript:void(0);" onclick="memberinfo(\'' + value + '\');"><strong>' + value + '</strong></a>';

                        } },
                        { display: '微信名', name: 'wechaname', align: 'left', width: 110 },
                        {
                            display: '车牌号1', name: 'carno', width: 80, render: function (rowdata, index, value) {

                                return '<a href="javascript:void(0);" onclick="viewcarinfo(\'' + value + '\');"><strong>' + value + '</strong></a>';

                            }
                        },
                      {
                          display: '车牌号2', name: 'carno1', width: 80, render: function (rowdata, index, value) {
                          return '<a href="javascript:void(0);" onclick="viewcarinfo(\'' + value + '\');"><strong>' + value + '</strong></a>';

                      }
                   },
                  {
                      display: '车牌号3', name: 'carno2', width: 80, render: function (rowdata, index, value) {

                          return '<a href="javascript:void(0);" onclick="viewcarinfo(\'' + value + '\');"><strong>' + value + '</strong></a>';

                      }
                  },
                  { display: '联系电话', name: 'tel', width: 100 },
                  {
                      display: '领卡时间', name: 'getcardtime', width: 90, render: function (rowdata, index, value) {
                          if (value > 0)
                              return formatdate('Y-m-d', value);
                          return value;
                      }
                  },
                  { display: '积分', name: 'total_score', width: 60 },
                  { display: '消费总额(元)', name: 'expensetotal', align: 'left', width: 80 },
                  { display: '余额', name: 'balance', width: 80 },
                 {
                    display: '操作', name: '操作', minWidth: 200, render: function (rowdata, index, value) {
                        var html='<a href="javascript:void(0);" onclick="memberCardRecharge(\''+rowdata.wecha_id+'\')"><strong>充值</strong></a>';
                        html+= '|<a href="javascript:void(0);" onclick="RestPassWord(\'' + rowdata.wecha_id + '\');"><strong>密码重置</strong></a>';
                        html += '|<a href="javascript:void(0);" onclick="presetcoupon(\'' + rowdata.wecha_id + '\')"><strong>送券</strong></a>';
                        html+='|<a href="javascript:void(0);" onclick="bingCard(\'' + rowdata.wecha_id + '\',\'' + rowdata.number + '\');"><strong>绑定车牌</strong></a>';
                        html+='| <a href="javascript:void(0);" onclick="delcar(\''+rowdata.wecha_id+'\');"><strong>删除车牌</strong></a>';
                        html+='| <a href="javascript:void(0);" onclick="modifycar(\''+rowdata.wecha_id+'\');"><strong>修改车牌</strong></a>';
                        html+='|<a href="javascript:void(0);" onclick="deletemember(\''+rowdata.id+'\');"><strong>删除会员</strong></a>';
                        return html;
                    }
                }
                ],
                isScroll: true,
                pageSize: 15,
                pageSizeOptions: [8, 10, 15, 20, 50],
                url: '/index.php?g=Query&m=Consume&a=getmembers',
                height: '98%',
                totalRender: f_totalRender,
                onDblClickRow: function (data, rowindex, rowobj) {
                    // wxinfo(data['流水号']);
                }
            });
            function f_totalRender(data, currentPageData) {
                return " 会员数:" + data.sumdata.count
                    + "  平均消费:" + data.sumdata.avgexpence+'元'
                    + "  剩余积分:" + data.sumdata.total_score+'分'
                    + "  余额:" + data.sumdata.balance + '元';
                  
            }
            $('#shop').click(function () {
                $('#search').click();
            });
            $('#search').click(function () {
                var parms = {};
                var endDate = $('#my-endDate').text();
                if (endDate != '')
                    parms.enddate = endDate;
                var startDate = $('#my-startDate').text();
                if (startDate != '')
                    parms.startdate = startDate;
                var searchkey = $('#searchkey').val();
                if (searchkey != '')
                    parms.searchkey = searchkey;
                var shop = $('#shop').val();
                if (shop != '')
                    parms.shop = shop;
                grid.set('parms', parms);
                grid.reload();
            });
        });
        var cardialog, memberdialog,coupondialog;
        function viewcarinfo(carno) {
            if (cardialog) {
                cardialog.setUrl('/index.php?g=Query&m=Consume&a=carinfo&carno=' + carno);
                cardialog.show();
            }
            else {
                cardialog = $.ligerDialog.open({
                    height: 500,
                    url: '/index.php?g=Query&m=Consume&a=carinfo&carno=' + carno,
                    width: 900,
                    showMax: true,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: false,
                    title: '车俩信息编辑'
                });
            }
        }
        function memberinfo(carno) {
            if (memberdialog) {
                memberdialog.setUrl('/index.php?g=Query&m=Consume&a=memberinfo&carno=' + carno);
                memberdialog.show();
            }
            else {
                memberdialog = $.ligerDialog.open({
                    height: 500,
                    url: '/index.php?g=Query&m=Consume&a=memberinfo&carno=' + carno,
                    width: 900,
                    showMax: true,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: false,
                    title: '会员资料编辑'
                });
            }
        }
        function bingCard(wecha_id,cardno) {
            $('#doc-modal-2').modal({
                relatedTarget: this,
                width: 400,
                closeOnConfirm: false,
                onConfirm: function (e) {
                    var carno = $('#carno').val();
                    reg = /^[\u4e00-\u9fa5][A-Z][0-9a-zA-Z]{5}$/i;
                    reg2 = /^[\u4e00-\u9fa5][A-Z][0-9a-zA-Z]{4}[\u4e00-\u9fa5]$/i;
                    if (!reg.test(carno) && !reg2.test(carno)) {
                        $.alert("请输入完整的车牌号码，格式如粤T83G5NB");
                        return;
                    }
                    var data = {
                        wecha_id: wecha_id,
                        cardno: cardno,
                        carno: carno
                    };
                    $.post('/index.php?g=Query&m=Consume&a=bindcar', data,
                      function (msg) {
                          alert(msg);
                          $('#doc-modal-2').modal('close');
                          location.href = location.href;
                      });
                },
                onCancel: function (e) {
                }
            });

        }
        function delcar(wecha_id, cardno){
            $.get('/index.php?g=Query&m=Consume&a=getcarno&wecha_id=' + wecha_id,
                      function (data) {
                          data = JSON.parse(data);
                          $('#carlist').empty();
                          $(data).each(function () {
                              var option = "<option value='" + this.carno + "'>" + this.carno + "</option>";
                              $('#carlist').append(option);
                          });
                      }
               );
            $('#doc-modal-3').modal({
                relatedTarget: this,
                width: 400,
                closeOnConfirm: false,
                onConfirm: function (e) {
                    var carno = $('#carlist').val();
                    var data = {
                        wecha_id: wecha_id,
                        carno: carno
                    };
                    $.post('/index.php?g=Query&m=Consume&a=delcar', data,
                      function (msg) {
                          alert(msg);
                          $('#doc-modal-3').modal('close');
                          location.href = location.href;
                      });
                },
                onCancel: function (e) {
                }
            });

        }
        function modifycar(wecha_id, cardno) {
            $.get('/index.php?g=Query&m=Consume&a=getcarno&wecha_id=' + wecha_id,
                      function (data) {
                          data = JSON.parse(data);
                          $('#carlist1').empty();
                          $(data).each(function () {
                              var option = "<option value='" + this.carno + "'>" + this.carno + "</option>";
                              $('#carlist1').append(option);
                          });
                      }
               );
            $('#doc-modal-4').modal({
                relatedTarget: this,
                width: 400,
                closeOnConfirm: false,
                onConfirm: function (e) {
                    var carno = $('#carno1').val();
                    reg = /^[\u4e00-\u9fa5][A-Z][0-9a-zA-Z]{5}$/i;
                    reg2 = /^[\u4e00-\u9fa5][A-Z][0-9a-zA-Z]{4}[\u4e00-\u9fa5]$/i;
                    if (!reg.test(carno) && !reg2.test(carno)) {
                        $.alert("请输入完整的车牌号码，格式如粤T83G5NB");
                    }
                    var data = {
                        wecha_id: wecha_id,
                        oldcarno: $('#carlist1').val(),
                        carno: carno
                    };
                    $.post('/index.php?g=Query&m=Consume&a=modifycar', data,
                      function (msg) {
                          alert(msg);
                          $('#doc-modal-4').modal('close');
                          location.href = location.href;
                      });
                },
                onCancel: function (e) {
                }
            });

        }
        function getCookie(name) {
            var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
            if (arr = document.cookie.match(reg))
                return eval(unescape(arr[2].replace(/\u/g, "%u")));
            else
                return null;
        }
        function memberCardRecharge(wecha_id) {
            $('#doc-modal-1').modal({
                relatedTarget: this,
                width: 350,
                closeOnConfirm:false,
                onConfirm: function(e) {
                    var price = $('#price').val();
                    if (getCookie('username') !="阳伟鹏") {
                        if (!(price && price >= 100)) {
                            $.alert({ title: '提示', content: "充值金额必须大于等于100元" });
                            return false;
                        }
                    }
                    var data = {
                        wecha_id: wecha_id,
                        price: price,
                        paytype: $('#paytype').val()
                    };
                    $.post('/index.php?g=Query&m=Consume&a=recharge', data,
                      function (msg) {
                          alert(msg);
                          $('#doc-modal-1').modal('close');
                          location.href = location.href;
                });
              },
                onCancel: function(e) {
              }
    });
        }
        function RestPassWord(id) {
            if (confirm("您确认要进行密码重置操作？")) {
                $.post('/index.php?g=Query&m=Consume&a=resetpass&wecha_id=' + id, null,
                function (data) {
                    if (data.success == 1) {
                        alert(data.msg);
                    } else {
                        alert(data.msg);
                    }
                }, "json");
            }
        }
        function deletemember(id) {
            if (confirm("您确认要删除？")) {
                $.post('/index.php?g=Query&m=Consume&a=member_del&id=' + id, null,
                function (data) {
                   alert(data);
                });
            }
        }
        function presetcoupon(wechaid) {
            if (coupondialog) {
                coupondialog.setUrl('/index.php?g=Query&m=Consume&a=presentcoupon&wecha_id=' + wechaid);
                coupondialog.show();
            }
            else {
                coupondialog = $.ligerDialog.open({
                    height: 300,
                    url: '/index.php?g=Query&m=Consume&a=presentcoupon&wecha_id=' + wechaid,
                    width: 460,
                    showMax: false,
                    showToggle: true,
                    showMin: false,
                    isResize: true,
                    modal: false,
                    title: '优惠券赠送'
                });
            }
        }

    </script>
</body>
</html>
